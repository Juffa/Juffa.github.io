<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Camera rotator</title>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

    <!-- Custom styles for this template -->
    <link href="../album.css" rel="stylesheet">
  </head>

  <body>

      <header class="fixed-top" id="header">
     
        </header>

    <main class="container-fluid" role="main">
            
      <section class="jumbotron-fluid bg-dark mb-1">
            <a href="../Portfolio.html" class="text-right">&lt;--Back to Portfolio</a>
        <div class="container-fluid">
          <h1 class="jumbotron-heading text-center text-white">An Arduino-controlled motorized panoramic tripod head</h1>
          <p class="lead text-center text-muted">Juha Kaikko</p>
          
            </small>

        </div>
      </section>

        <div class="container-fluid" id="container">
            <div class="row bg-dark mt-1 pt-4">
                <!--margin-top 1, padding top and bottom 4-->
                <div class="col-md-12 pb-4">
                  <!--column width 8/12 of total width, padding-bottom 4 -->
                  <p class="text-white lead">
                      "I don't know anything about any of this, what is this thing?"
                  </p>
                  <p class="text-white">
                    It is a device that can rotate a camera around so that it can take pictures at every direction while staying in exactly the same spot. 
                    <br>
                    The photos can then be combined into one large image like so:
                  </p>
                </div>
              </div><!--row-->
              
              <div class="row bg-dark">
                  <div class="col-md-6 ">
                      <div class="card mb-4 shadow-sm">
                        <a href="https://www.flickr.com/photos/jkk79/26449161539"><img class="card-img-top" src="https://c1.staticflickr.com/5/4474/26449161539_eec5b39df4_z.jpg" title="Kirjastoaukio"></a>
                     </div>
                  </div>
  
                  <div class="col-md-6 ">
                      <div class="card mb-4 shadow-sm">
                        <a href="https://www.flickr.com/photos/jkk79/38193586932"><img class="card-img-top" src="https://c1.staticflickr.com/5/4542/38193586932_f30fcb1bac_z.jpg" title="Puolimatka"></a>
                     </div>
                  </div>
                </div><!--row-->
                <div class="row bg-dark">
                  <div class="col-md-12">
                  <p class="text-white lead">
                    "How does it work?"
                  </p>
                  </div>
                </div>
                <div class="row bg-dark">
                  <div class="col-md-12 embed-responsive embed-responsive-16by9">
                    <iframe class="embed-responsive-item px-3 py-3" src="https://www.youtube.com/embed/tQty9Q9_Qvs?rel=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
                  </div>
                </div>

              

          <div class="row bg-dark mt-1 py-4">
            <!--margin-top 1, padding top and bottom 4-->
            
            <div class="col-md-8 pb-4">
              <!--column width 8/12 of total width, padding-bottom 4 -->
              <p class="text-white lead">
                  A bit of backstory:
              </p>
              <p class="text-white">
                I like photography, and I ran into these panorama images that were stitched from multiple shots.
                I found a free software people were using for stitching (Hugin), as the normal photoshopping just won't do 
                since photos need to be stretched, rotated, cut and pasted correctly, taking lens properties into the account.
                <br>
                The software was amazing, in addition to normal rectilinear projection, it can create images with many different projections,
                Including the stereographic projection.
                <br>
                <br>
                If you take a shot to every direction covering the whole 360-degree field of view, including up and down, you can stitch the shots into one large image,
                and with the stereographic projection you can then create <a href="https://kuula.co/post/7lc9H" style="text-decoration:underline">these photospheres</a>, 
                where you can look around into every direction.
                You can also make those <a href="https://www.flickr.com/photos/jkk79/23544236858/" style="text-decoration:underline">tiny planet</a> 
                or <a href="https://www.flickr.com/photos/jkk79/36726110743" style="text-decoration:underline">inverse tiny-planet</a> -images with the stereographic projection.
                <br>
                But there is a catch! Between each shot the camera must be rotated precisely around the lens's entrance pupil, 
                which is inside the the lens, to eliminate any parallax movement.
                <br>
                <br>
                "Parallax is a displacement or difference in the apparent position of an object viewed along two different lines of sight" (Wikipedia).
                <br> 
                So if the camera isn't rotated around the lens's entrance pupil in all three axis, 
                any objects that are at different distances from the camera seem to move in relation to each other, and then stitching produces bad results.
                <br>
                Sure, you can sometimes get 'ok' results with freehanding the camera, 
                you really need a tripod and panoramic head made for this purpose, but they tend to be expensive.
                <br>
                While researching the subject I stumbled upon a device that rotates the camera and takes the shots... And I really wanted one!
                <br>
                ...Too bad it was around 1000€.
                <br>
                <br>
                But then I bought a 3d printer and entered the wonderful world of Arduino and stepper motors 
                and this idea of designing and building my own motorized panoramic tripod head started to form. 
                
              </p>

            </div>
            <div class="col-md-4 px-4 pt-2 mb-1"  >
                <!--column width 4/12, padding-left and right 4, padding-top 2, margin-bottom 1-->
                <img class="img-fluid" src="https://i.imgur.com/QR6BEAD.jpg">
                </div>
            
          </div><!--row-->




          <div class="row bg-dark mt-1 py-4">
              <div class="col-md-4 px-4 pt-2">
                  <!--kuva?-->
                  <img class="img-fluid" src="https://i.imgur.com/dKz67om.png">
                </div>
           
            <div class="col-md-8 pb-4">
              <p class="text-white lead">
                  The design
              </p>
              <p class="text-white">
                My 3d-printer gave me an idea for the basic design, as some of it's frame is made out of 3d-printed parts and threaded rods.
                The idea was to save in plastic while making the structure stronger, though it also ended up weighting more than I thought it would.
                <br>
                I wanted to use my Nikon D700 with the rotator, but as the camera body is really heavy (almost 1kg), it creates some challenges for the design. 
                And that's still without any lenses, too... And then I found out that the lenses I wanted to use, especially the 14mm wide-angle one,
                have the entrance pupil quite far from the camera body, and it needs to be in the pivot point... 
                So the camera body needs to be sitting some 10cm (or more) from the pivot point, which creates a lot of torque. 
                Way more than any NEMA 17 stepper motors have.
                <br>
                Then I made some calculations, as I needed to know how much torque a 2kg mass would cause if it was about 10cm from the pivot point,
                and how much holding torque a typical NEMA 17 stepper motor has. I can't remember the details but even two motors were not enough,
                in fact I would need the two motors and 1:8 gears to transmit the power.
                <br>
                <br>
                The material causes some limitations though as the printed plastic isn't excatly the strongest possible, 
                and the printer can't really make fine enough details with 0,4mm nozzle, so the gears need to be quite large. 
                Too small teeth could just snap or deform in use, as the torque will be pretty high.
                Also, if I used a smaller nozzle, I sure could print finer details, but the parts would be even weaker.
                <br>
                This led to the decision to have the camera sit horizontally and to have the motors at the both ends.
                <br>
                <br>
                Luckily the gears were not a problem as I knew I could print my own gears, as the extruder in my 3d-printer has printed gears.
                The OpenScad file for gears is open source so I used it.
                <br>
                <br>
                I could make the design more compact and move the motors below the whole system and use belts instead of direct gears.
                There are many different sizes of timing belts in ebay and they would probably work really well, But for now I'll leave it as an upgrade path. 
                <br>
                <br>
                There were other parts that were more difficult to design, like the platform where the camera sits on, 
                as it needs to be able to move back and forth, but still be sturdy enough. Originally it was attached with 8mm threaded rods and fixed in place with nuts. 
                It was moveable but finetuning it was cumbersome, so I got some 8mm smooth rods so the platform can slide more easily, 
                and it's being held in place with 5mm threaded rods and nuts embedded in the platform, so when I rotate the rods, the nuts force the platform to move back or forth.
                <br>
                The height of the platform can be adjusted similarly, though it could be left fixed, at least as long as I use the same camera, 
                since the distance from the bottom of the camera body stays the same even if I change the lens. 
                <br>
                <br>
                Another maybe even more difficult part was the how the rotator is attached to a tripod, and I ended up with a solution where I turn the tripod's upper part(25mm pipe) upside down
                and mount the rotator directly on it.
                There is a small thrust bearing at the end of the hole in the pipe, and another larger bearing on top, 
                and the whole rotator sits on the large bearing, 
                and they are all fastened together with a bolt through the bearings and into the pipe (I had to remove the end cap from the pipe for this to work).
                <br>
                Even if the hole where the pipe goes in is quite tight fit, the whole rotator isn't as stable as I'd like, since the whole thing is so heavy. 
                Though running with lower speed and stopping for a moment before shooting removes all the vibrations.
              </p>
            </div>

          </div><!--row-->

        <div class="row bg-dark mt-1 py-4">
            <div class="col-md-8 pb-4">
              <p class="text-white lead">
                Arduino and other electronics
              </p>
              <p class="text-white">
                I needed something to control the stepper motors with, 
                and the obvious device for this is exactly the same that controls the stepper motors in the 3d-printer: Arduino.
                Though board in the printer is the Arduino Mega, I wouldn't need as many connections as it has. 
                In fact the Arduino Nano was perfect, and even better, they can be bought as cheap as 2-3€ from Ebay.
                <br>
                Also the stepper motor drivers were around 1-2€ a piece in Ebay, a Pololu A4988 or it's clone. My 3d-printer has the same drivers.
                <br>
                <br>
                So, I also got some small generic prototype boards from ebay, 
                soldered the arduino and the stepper drivers onto one and made the connections by soldering tiny wires on the backside.
                <br>
                I also needed to shoot the camera with the arduino, so I got some 5V relays and a shutter release cable for the camera. 
                But even if arduino outputs 5V from the logic pins, it's too weak to switch the relay so I used a small transistor to boost the power.
                <br>
                <br>
                Then I designed and printed a box for the electronics. First I was going to add a small fan into the box, since the stepper drivers heat up quite a bit,
                but I ended up just making a lot of small ventilation holes in the box desing. Later the main power switch broke because it couldn't handle the power. 
                The new bigger switch wouldn't fit, so I had to modify the box design and re-print it.
                <br>
                <br>
                The Arduino nano uses 5V DC power, like what you get from USB connector, but it also has a 5V regulator built-in so it can accept up to 12V DC. 
                The stepper drivers work best with 12V DC, so the obvious power source is a 12V battery or a transformer.
                <br>
                The whole device uses around 1.3A when turned on, and the usage stays about same if it's staying still or moving, 
                since the stepper motors need to hold the position when they are not turning.
                
              </p>
            </div>
            <div class="col-md-4 px-4 pt-2">
                <!--kuva?-->
                <img class="img-fluid" src="https://i.imgur.com/TqIlRkI.jpg">
            </div>
          </div><!--row-->

          <div class="row bg-dark mt-1 py-4">
              <div class="col-md-4 px-4 pt-2">
                  <!--kuva?-->
                  <img class="img-fluid" src="https://i.imgur.com/dKz67om.png">
                </div>
            <div class="col-md-8 pb-4">
              <p class="text-white lead">
                  The code
              </p>
              <p class="text-white">
                At the start of the project, Arduino (C/C++) was new to me, but I had a little experience with Java so getting started wasn't that difficult after all.
                There is also a lot of example code for different devices usually used with an Arduino, which is very helpful.
                <br>
                <br>
                Everything can be controlled with 3 buttons on the box, up, down and select. 
                The program I made has multiple operation modes, for example the 360x180 panorama, 
                and the <a href="https://www.youtube.com/watch?v=mqCh4uhhAaE" style="text-decoration:underline">panning timelapse mode.</a><br>
                The default settings are ok in broad daylight, but if you want to shoot with longer exposure time, it can be changed in the settings menu.
                It also defaults to 14mm lens, but there are many other sizes to choose from, like the 50mm which produces much higher quality than the 14mm, but requires more shots.
                <br>
                Of course, when changing the lens, the distance from the pivot point needs to be calibrated again, too.
                <br>
                <br>
                The 3d pieces are also made out of code, since in <a href="http://www.openscad.org/" style="text-decoration:underline">OpenSCAD</a> everything is typed as code.
                <br>
                For example, you create a 10x10x10mm cube with cube([10,10,10]);
                <br>
                Moving and rotating the cube works like this: translate([0,0,10])rotate([45,0,0])cube([10,10,10]);  
                <br>
                This moves the cube 10mm up in z-axis and rotates it 45 degrees in x-axis. 
                <br>
                Of course you can replace the numbers with variables, too.
                <br>
                <br>
                I wanted to move the project from Arduino to ESP8266, so I could control it from my cellphone over wifi.
                The ESP8266 board can be programmed with Arduino IDE too and it can use mostly the same code.
                <br>
                I already got most of the things working when I was testing around, but when I tried to run stepper motors with it, it just crashed.
                It turns out that because it has the wifi, the normal delays and other stuff cannot be used, since the wifi module crashes if there are too long delays.
                And the whole stepper driver is full of delays. I'd have to make my own driver which wouldn't use delays... But it turned out to be difficult.
                <br>
                So for now that idea is on hold.
                <br>
                <br>
                I've also been holding off on publishing any of the code because I use other people's libraries and I'm not sure how I should deal with it.

              </p>
            </div>
            
          </div><!--row-->
          <div class="row bg-dark mt-1 py-4">
              <div class="col-md-4 pb-4">
                <p class="text-white">
                  A 3d-view of the camera rotator.
                  <br>
                  Hmm, maybe I'll add some sort of part viewer? Or an animated version of how it operates? Maybe in the future?
                  <br>
                  The control box is missing from this, it's on a separate file.
                </p>
              </div>
              <div class="col-md-8 pb-4" id="3dview" style="height:500px">

              </div>

          </div><!--row-->
        </div><!--container-->

    </main>

    <footer class="text-muted">
      <div class="container-fluid">
            <a href="../Portfolio.html">&lt;--Back to Portfolio</a>
        <p class="float-right">
          <a href="#">Back to top</a><br>
          
        </p>
      </div>
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/holder/2.9.4/holder.min.js"></script>
  
    <script src="../three.min.js"></script>
    <script src="../STLLoader.js"></script>
    <script src="../WebGL.js"></script>
    <script src="../stats.min.js"></script>
    <script src="../OrbitControls.js"></script>
  <script>
      //$("body").prepend($('<header>').load("../index.html #header", function(){}));
        $("#header").load("../index.html #header > *");
        console.log("trying to load header");
  </script>

  <script>


				
  			if ( WEBGL.isWebGLAvailable() === false ) {
				document.body.appendChild( WEBGL.getWebGLErrorMessage() );
			}
			var camera, controls, scene, renderer;
      var container = document.getElementById("3dview");
			init();
			//render(); // remove when using next line for animation loop (requestAnimationFrame)
			animate();
			function init() {
        
				scene = new THREE.Scene();
				scene.background = new THREE.Color( 0xcccccc );
				//scene.fog = new THREE.FogExp2( 0xcccccc, 0.001 );
				renderer = new THREE.WebGLRenderer( { antialias: true } );
				renderer.setPixelRatio( window.devicePixelRatio );
				//renderer.setSize( window.innerWidth, window.innerHeight );
        //renderer.setSize( document.getElementById('3dcontainer').clientWidth, document.getElementById('3dcontainer').clientHeight );
        renderer.setSize(container.clientWidth-30,container.clientHeight);
				//document.body.appendChild( renderer.domElement );
				document.getElementById('3dview').appendChild(renderer.domElement);
        camera = new THREE.PerspectiveCamera( 60, container.clientWidth / container.clientHeight, 1, 1000 );
        camera.position.set( 400, 500, 200 );
				// controls
				controls = new THREE.OrbitControls( camera, renderer.domElement );
				//controls.addEventListener( 'change', render ); // call this only in static scenes (i.e., if there is no animation loop)
				controls.enableDamping = true; // an animation loop is required when either damping or auto-rotation are enabled
				controls.dampingFactor = 1.25;
				controls.screenSpacePanning = false;
				controls.minDistance = 10;
				controls.maxDistance = 2000;
				controls.maxPolarAngle = Math.PI / 2;
				// world
				//var geometry = new THREE.CylinderBufferGeometry( 0, 10, 30, 4, 1 );
				//var material = new THREE.MeshPhongMaterial( { color: 0xffffff, flatShading: true } );




          var loader = new THREE.STLLoader();
          var material = new THREE.MeshPhongMaterial( { color: 0xAAAAAA, specular: 0x111111, shininess: 200 } );
				  loader.load( '../portfolio/Camerarotator/camerahead3.stl', function ( geometry ) {
					var stl = new THREE.Mesh( geometry, material );
					stl.position.set( 0, -200, 0 );
					stl.rotation.set( -Math.PI / 2, 0, 0 );
					stl.scale.set( 1, 1, 1 );
					stl.castShadow = true;
					stl.receiveShadow = true;
					scene.add( stl );
          });

				// lights
				var light = new THREE.DirectionalLight( 0xffffff );
				light.position.set( 1, 1, 1 );
				scene.add( light );
				var light = new THREE.DirectionalLight( 0x002288 );
				light.position.set( - 1, - 1, - 1 );
				scene.add( light );
				var light = new THREE.AmbientLight( 0x222222 );
				scene.add( light );
				//
				window.addEventListener( 'resize', onWindowResize, false );
			}
			function onWindowResize() {
				camera.aspect = container.clientWidth / container.clientHeight;
				camera.updateProjectionMatrix();
				renderer.setSize( container.clientWidth-30, container.clientHeight );
			}
			function animate() {
				requestAnimationFrame( animate );
				controls.update(); // only required if controls.enableDamping = true, or if controls.autoRotate = true
				render();
			}
			function render() {
				renderer.render( scene, camera );
			}
  </script>

  </body>
</html>
